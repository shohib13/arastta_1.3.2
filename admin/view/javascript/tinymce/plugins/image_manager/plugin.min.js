var TinyMCE_editor;

tinymce.PluginManager.add("image_manager", function (editor, url) {
    function showImageManager() {
        TinyMCE_editor = editor;

        $('#modal-image').remove();

        $.ajax({
            url: 'index.php?route=common/filemanager&token=' + getURLVar('token'),
            dataType: 'html',
            beforeSend: function() {
                $('#button-image i').replaceWith('<i class="fa fa-circle-o-notch fa-spin"></i>');
                $('#button-image').prop('disabled', true);
            },
            complete: function() {
                $('#button-image i').replaceWith('<i class="fa fa-upload"></i>');
                $('#button-image').prop('disabled', false);
            },
            success: function(html) {
                $('body').append('<div id="modal-image" class="modal">' + html + '</div>');

                $('#modal-image').modal('show');
            }
        });
    }

    editor.addButton("image_manager", {
        icon         : "image",
        tooltip      : "Insert image",
        onclick      : showImageManager,
        stateSelector: "img:not([data-mce-object],[data-mce-placeholder])"
    }),
    editor.addMenuItem("image_manager", {
        icon            : "image",
        text            : "Insert image",
        onclick         : showImageManager,
        context         : "insert",
        prependToContext: !0
    })
});

function InsertTinyMCEImage(src) {
    TinyMCE_editor.insertContent('<img src="' + src + '" />');

    $('#modal-image').remove();
    $('body').removeClass('modal-open');
}